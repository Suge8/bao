# bao 安全模型

## 信任模型

| 实体          | 信任级别 | 理由                     |
| ------------- | -------- | ------------------------ |
| 主群组        | 受信任   | 私有 self-chat，管理控制 |
| 非主群组      | 不受信任 | 其他用户可能是恶意的     |
| 容器智能体    | 沙箱化   | 隔离的执行环境           |
| WhatsApp 消息 | 用户输入 | 潜在的提示注入           |

## 安全边界

### 1. 容器隔离（主要边界）

智能体在 Apple Container（轻量级 Linux 虚拟机）中执行，提供：

- **进程隔离** - 容器进程不会影响宿主
- **文件系统隔离** - 仅显式挂载的目录可见
- **非 root 执行** - 以非特权 `node` 用户运行（uid 1000）
- **临时容器** - 每次调用全新环境（`--rm`）

这是主要安全边界。与其依赖应用级权限检查，不如通过挂载内容来限制攻击面。

### 2. 挂载安全

**外部白名单** - 挂载权限存储在 `~/.config/bao/mount-allowlist.json`，它：

- 在项目根目录之外
- 永远不会挂载到容器中
- 无法被智能体修改

**默认阻止的模式：**

```
.ssh, .gnupg, .aws, .azure, .gcloud, .kube, .docker,
credentials, .env, .netrc, .npmrc, id_rsa, id_ed25519,
private_key, .secret
```

**保护措施：**

- 验证前解析符号链接（防止遍历攻击）
- 容器路径验证（拒绝 `..` 和绝对路径）
- `nonMainReadOnly` 选项强制非主群组为只读

### 3. 会话隔离

每个群组在 `data/sessions/{group}/.claude/` 有隔离的 Claude 会话：

- 群组无法看到其他群组的会话历史
- 会话数据包括完整的消息历史和已读取的文件内容
- 防止跨群组信息泄露

### 4. IPC 授权

消息和任务操作会根据群组身份进行验证：

| 操作                 | 主群组 | 非主群组 |
| -------------------- | ------ | -------- |
| 向自己的聊天发送消息 | ✓      | ✓        |
| 向其他聊天发送消息   | ✓      | ✗        |
| 为自己调度任务       | ✓      | ✓        |
| 为其他群组调度任务   | ✓      | ✗        |
| 查看所有任务         | ✓      | 仅自己的 |
| 管理其他群组         | ✓      | ✗        |

### 5. 凭证处理

**已挂载的凭证：**

- Claude 认证令牌（从 `.env` 过滤，只读）

**未挂载的：**

- WhatsApp 会话（`store/auth/`）- 仅宿主
- 挂载白名单 - 外部，永不挂载
- 匹配阻止模式的任何凭证

**凭证过滤：**
仅以下环境变量暴露给容器：

```typescript
const allowedVars = ['CLAUDE_CODE_OAUTH_TOKEN', 'ANTHROPIC_API_KEY'];
```

> **注意：** Anthropic 凭证被挂载是为了让 Claude Code 在智能体运行时能够认证。然而，这意味着智能体本身可以通过 Bash 或文件操作发现这些凭证。理想情况下，Claude Code 应该在不将凭证暴露给智能体执行环境的情况下进行认证，但我没能找到方法。如果你有凭证隔离的想法，**欢迎提交 PR**。

## 权限对比

| 能力           | 主群组                       | 非主群组                    |
| -------------- | ---------------------------- | --------------------------- |
| 项目根目录访问 | `/workspace/project`（读写） | 无                          |
| 群组文件夹     | `/workspace/group`（读写）   | `/workspace/group`（读写）  |
| 全局记忆       | 通过项目隐式获取             | `/workspace/global`（只读） |
| 额外挂载       | 可配置                       | 除非允许否则只读            |
| 网络访问       | 不受限制                     | 不受限制                    |
| MCP 工具       | 全部                         | 全部                        |

## 安全架构图

```
┌──────────────────────────────────────────────────────────────────┐
│                        不受信任区域                                │
│  WhatsApp 消息（可能是恶意的）                                     │
└────────────────────────────────┬─────────────────────────────────┘
                                 │
                                 ▼ 触发检查，输入转义
┌──────────────────────────────────────────────────────────────────┐
│                     宿主进程（受信任）                              │
│  • 消息路由                                                       │
│  • IPC 授权                                                       │
│  • 挂载验证（外部白名单）                                          │
│  • 容器生命周期                                                    │
│  • 凭证过滤                                                       │
└────────────────────────────────┬─────────────────────────────────┘
                                 │
                                 ▼ 仅显式挂载
┌──────────────────────────────────────────────────────────────────┐
│                容器（隔离/沙箱化）                                  │
│  • 智能体执行                                                      │
│  • Bash 命令（沙箱化）                                             │
│  • 文件操作（限于挂载范围）                                         │
│  • 网络访问（不受限制）                                             │
│  • 无法修改安全配置                                                 │
└──────────────────────────────────────────────────────────────────┘
```
