# bao 需求文档

项目需求和设计决策。

---

## 为什么创建这个项目

市面上的 AI 助手项目要么太复杂（几十个模块、无数配置文件），要么安全性不够（智能体和主机共享内存、仅靠应用级权限控制）。

bao 用一个你能完全看懂的代码库，提供核心功能。一个进程，几个文件。智能体运行在真正的 Linux 容器中，操作系统级隔离。

---

## 设计哲学

### 小到可以理解

整个代码库应该是你可以阅读和理解的。一个 Node.js 进程。一把源文件。没有微服务，没有消息队列，没有抽象层。

### 通过真正的隔离保障安全

与其使用应用级权限系统来试图阻止智能体访问某些东西，智能体运行在真正的 Linux 容器（Apple Container）中。隔离在操作系统级别。智能体只能看到被明确挂载的内容。Bash 访问是安全的，因为命令在容器内运行，而不是在你的 Mac 上。

### 为单一用户打造

这不是一个框架或平台。这是为我特定需求打造的可工作的软件。我用 WhatsApp、iMessage 和邮件，所以它支持这些渠道。我不用 Telegram，所以它不支持 Telegram。我添加我真正需要的集成，而不是每一种可能的集成。

### 定制即代码修改

没有配置泛滥。如果你想要不同的行为，修改代码。代码库足够小，这样做是安全和实际的。像触发词这样极少量的东西放在配置中。其他一切 - 直接修改代码来实现你想要的。

### AI 原生开发

我不需要安装向导 - Claude Code 指导安装。我不需要监控仪表盘 - 我问 Claude Code 发生了什么。我不需要精心设计的日志 UI - 我让 Claude 读日志。我不需要调试工具 - 我描述问题，Claude 修复它。

代码库假设你有一个 AI 协作者。它不需要过度自文档化或自调试，因为 Claude 始终在那里。

### 技能优于功能

新功能通过 Claude Code 技能（`/setup`、`/customize`、`/debug`）添加，而不是直接堆代码。代码库始终保持精简。

---

## 愿景

通过 WhatsApp / iMessage 访问的个人 Claude 助手，使用最少的自定义代码。

**核心组件：**

- **Claude Agent SDK** 作为核心智能体
- **Apple Container** 用于隔离的智能体执行（Linux 虚拟机）
- **WhatsApp** 作为主要 I/O 渠道
- **iMessage** 作为可选 I/O 渠道（macOS，`IMESSAGE_ENABLED=true`）
- **持久记忆** 每个会话和全局
- **计划任务** 运行 Claude 并可以回发消息
- **网络访问** 用于搜索和浏览
- **浏览器自动化** 通过 agent-browser

**实现方法：**

- 使用现有工具（WhatsApp 连接器、Claude Agent SDK、MCP 服务器）
- 最少的胶水代码
- 尽可能使用基于文件的系统（CLAUDE.md 用于记忆，文件夹用于群组）

---

## 架构决策

### 消息路由

- 路由器监听 WhatsApp 并根据配置路由消息
- 仅处理来自已注册群组的消息
- 触发：`@bao` 前缀（不区分大小写），可通过 `ASSISTANT_NAME` 环境变量配置
- 未注册的群组完全被忽略

### 记忆系统

- **每群组记忆**：每个群组有一个带有自己 `CLAUDE.md` 的文件夹
- **全局记忆**：根目录的 `CLAUDE.md` 被所有群组读取，但仅可从"主"频道（self-chat）写入
- **文件**：群组可以在其文件夹中创建/读取文件并引用它们
- 智能体在群组文件夹中运行，自动继承两个 CLAUDE.md 文件

### 会话管理

- 每个群组维护一个会话（通过 Claude Agent SDK）
- 会话在上下文过长时自动压缩，保留关键信息

### 容器隔离

- 所有智能体运行在 Apple Container（轻量级 Linux 虚拟机）中
- 每次智能体调用都会生成一个带有挂载目录的容器
- 容器提供文件系统隔离 - 智能体只能看到已挂载的路径
- Bash 访问是安全的，因为命令在容器内运行，而不是在宿主上
- 通过容器中的 Chromium 和 agent-browser 进行浏览器自动化

### 计划任务

- 用户可以在任何群组中要求 Claude 调度周期性或一次性任务
- 任务作为完整智能体在创建它们的群组上下文中运行
- 任务可以使用所有工具，包括 Bash（在容器中是安全的）
- 任务可以选择通过 `send_message` 工具向其群组发送消息，或静默完成
- 任务运行记录到数据库，包含持续时间和结果
- 调度类型：cron 表达式、间隔（毫秒）或一次性（ISO 时间戳）
- 从主频道：可以为任何群组调度任务，查看/管理所有任务
- 从其他群组：只能管理该群组的任务

### 群组管理

- 新群组通过主频道显式添加
- 群组在 SQLite 中注册（通过主频道或 IPC `register_group` 命令）
- 每个群组在 `groups/` 下有一个专用文件夹
- 群组可以通过 `containerConfig` 配置额外的挂载目录

### 主频道权限

- 主频道是管理/控制群组（通常是 self-chat）
- 可以写入全局记忆（`groups/CLAUDE.md`）
- 可以为任何群组调度任务
- 可以查看和管理所有群组的任务
- 可以为任何群组配置额外的目录挂载

---

## 集成点

### WhatsApp

- 使用 baileys 库进行 WhatsApp Web 连接
- 消息存储在 SQLite 中，由路由器轮询
- 安装过程中通过二维码认证

### 调度器

- 内置调度器在宿主上运行，生成容器执行任务
- 自定义 `bao` MCP 服务器（容器内）提供调度工具
- 工具：`schedule_task`、`list_tasks`、`pause_task`、`resume_task`、`cancel_task`、`send_message`
- 任务存储在 SQLite 中，带有运行历史
- 调度器循环每分钟检查到期任务
- 任务在容器化的群组上下文中执行 Claude Agent SDK

### 网络访问

- 内置 WebSearch 和 WebFetch 工具
- 标准 Claude Agent SDK 功能

### 浏览器自动化

- 容器中的 agent-browser CLI 和 Chromium
- 基于快照的交互，带元素引用（@e1, @e2 等）
- 截图、PDF、视频录制
- 认证状态持久化

---

## 安装与定制

### 哲学

- 最少的配置文件
- 安装和定制通过 Claude Code 完成
- 用户克隆仓库并运行 Claude Code 进行配置
- 每个用户得到匹配其确切需求的自定义安装

### 技能

- `/setup` - 安装依赖、认证 WhatsApp、配置调度器、启动服务
- `/customize` - 通用技能，用于添加功能（新渠道如 Telegram、新集成、行为变更）

### 部署

- 通过 launchd 在本地 Mac 上运行
- 单个 Node.js 进程处理一切

---

## 个人配置（参考）

以下是创建者的设置，存储在此处供参考：

- **触发词**：`@bao`（不区分大小写）
- **响应前缀**：`bao:`
- **人设**：默认 Claude（无自定义人格）
- **主频道**：Self-chat（在 WhatsApp 中给自己发消息）

---

## 项目名称

**bao** - 个人 Claude 助手。
